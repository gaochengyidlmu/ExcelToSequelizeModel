const
  uuid = require('uuid')
  , dl = require('debug')('dbmodles:log')
  , de = require('debug')('dbmodles:error')
  , config = require('../config')
  , Sequelize = require('sequelize')
  , cfg = require('../config/appconfig/args')
  ;

module.exports = (sequelize)=>{
<%
  const _id = 2
          ,_note = 3
          ,_type = 4
          ,_primary = 5
          ,_foreign = 6
          ,_toTable = 7
          ,_description = 8
          ,_default = 9
          ,_noAllowNull = 10
          ,_unique = 11
          ,_index = 12
          ,_readOnly = 13
          ,_values = 14
          ,_middle = 15
          ,_middle1 = 16
          ,_middle2 = 17
  ;
  let assArr = [], tableName;
  for(let i = 0, len = files.length; i < len; i++){
    let data = files[i].data;
    data.shift();
    tableName = data[0][3]
//    if(i==3)console.log('data: ',data)
%>
  const <%- tableName %> = sequelize.define("<%- tableName %>", {
  <%
  let fieldArr = data.slice(2, data.length);
  //foreignFlag:true => 对于非中间表需要计算外键
  //foreignFlag:false => 对于中间表不需要计算外键
  let generator = (foreignFlag)=>{
    for(let j = 0, _len = fieldArr.length; j < _len; j++){
      let field = fieldArr[j];

      //当id存在且不为createdAt、updatedAt时才能继续
      if(common.isExist(field[_id]) && ['createdAt','updatedAt'].indexOf(field[_id]) == -1 ){
        //当不为外键时
        if(field[_foreign] !== '√'){%>  <%-field[_id] %>: {type: Sequelize.<%- field[_type] %> <%/* ENUM 的值 */ if (field[_type] === 'ENUM') { %>, values: Object.keys(<%- field[_values]%>) <% }%>,<% /*主键时*/if(field[_primary] == '√'){ %> primaryKey: true,<% if(field[_type]==='INTEGER'){%> autoIncrement: true ,<%}} %><% /*有默认值时*/if(common.isExist(field[_default])){ %> defaultValue: <%- field[_default] %>, <%}%><% /*不允许为空时*/if(field[_noAllowNull] == '√'){ %> allowNull: false, <%} %><% /*独一unique时*/if(field[_unique] == '√'){ %> unique: true, <%} %><% /*联合unique时*/if(field[_unique] != '√' && common.isExist(field[_unique])){ %> unique: '<%= field[_unique]%>', <%} %><% /*只读，不用编辑时*/if(field[_readOnly] == '√'){ %> readOnly: true, <%} %>}, //<%- field[_note] %>，<%- field[_middle] %>
  <%}else if(foreignFlag === true){
        //当为外键时，将对应的语句push入assArr关联数组中
        let temArr = [];
        temArr[0] = `models.${tableName}.belongsTo(models.${field[_toTable]},{foreignKey:{name: '${field[_id]}'`;
        temArr[1] = `models.${field[_toTable]}.hasMany(models.${tableName},{foreignKey:{name: '${field[_id]}'`;

        let addStr = '}});';
        /*为必选项时*/
        if(field[_noAllowNull] == '√') addStr = `, allowNull: false` + addStr;
        /*只读，不用编辑时*/
        if(field[_readOnly] == '√') addStr = `, readOnly : true` + addStr;

        temArr[0] += addStr;
        temArr[1] += addStr;

        assArr = assArr.concat(temArr);
        assArr.push('' +
                '')
        }
      }
    }
  }
  let cIndex = ()=>{
    for(let j = 0, _len = fieldArr.length; j < _len; j++) {
      let field = fieldArr[j];

      //当id存在，且不为createdAt、updatedAt、且不为外键、且index存在才能继续
      if(common.isExist(field[_id])
        && ['createdAt','updatedAt'].indexOf(field[_id]) == -1
        && field[_foreign] !== '√'
        && field[_index] === '√'
      ){%>{method: 'BTREE',fields: ['<%= field[_id] %>']},
      <%}
    }
  }
    //当不是中间表时
    if(data[0][_middle] !== '中间表'){
      generator(true)
    }else{
      //为中间表时
      let temp1 = `models.${data[0][_middle1]}.belongsToMany(models.${data[0][_middle2]},{through:'${tableName}'});`;
      let temp2 = `models.${data[0][_middle2]}.belongsToMany(models.${data[0][_middle1]},{through:'${tableName}'});`;
      assArr.push(temp1);
      assArr.push(temp2);
      assArr.push('' +
              '')
      generator(false)
    }
  %>},{
    freezeTableName: true,
    indexes:[
      <%cIndex()%>
    ],
    description: '<%=data[0][_description]%>'
  });
<% }
cb(assArr) %>};
